<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prodotto • Il Capitano</title>

  <style>
    :root{
      --ink:#141414;
      --muted:#5b666c;
      --sea:#0b5f76;
      --sea2:#0e7ea0;
      --sand:#f2e7c9;
      --paper:#fbfaf6;
      --paper2:#f6f3ea;
      --line:rgba(0,0,0,.14);
      --shadow:0 16px 44px rgba(0,0,0,.10);
      --r:18px;
      --max:1200px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background: linear-gradient(180deg, var(--paper2), #fff 45%);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .brand img{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--line); background:#fff;
    }
    .sub{
      font-weight:600; color:var(--muted); font-size:13px;
    }
    .btn{
      appearance:none; border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      color:var(--ink);
      box-shadow:0 10px 20px rgba(0,0,0,.06);
    }
    .btn:hover{border-color:rgba(11,95,118,.35)}

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:18px 16px 40px;
    }

    .sheet{
      background: linear-gradient(180deg, #fff, var(--paper));
      border:1px solid var(--line);
      border-radius:24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet-head{
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(242,231,201,.35), transparent);
    }
    .crumbPill{
      display:inline-flex;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(14,126,160,.22);
      background: rgba(14,126,160,.06);
      color: var(--sea);
      font-weight:900;
      letter-spacing:.25px;
      text-transform:uppercase;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:72%;
    }
    .sku{
      color:var(--muted);
      font-weight:900;
      letter-spacing:.5px;
      font-size:13px;
      white-space:nowrap;
    }

    .sheet-body{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:0;
    }

    .gallery{
      padding:18px;
      border-right:1px solid var(--line);
      display:grid;
      grid-template-columns: 72px 1fr;
      gap:14px;
      min-height:420px;
    }
    .thumbs{display:flex; flex-direction:column; gap:10px;}
    .thumb{
      width:72px; height:72px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      padding:8px;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(0,0,0,.07);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .thumb img{width:100%; height:100%; object-fit:contain}
    .thumb.active{outline:3px solid rgba(14,126,160,.22); border-color:rgba(14,126,160,.35)}

    .mainImg{
      border-radius:20px;
      border:1px solid var(--line);
      background: radial-gradient(900px 500px at 50% 20%, rgba(242,231,201,.55), transparent 60%), #fff;
      box-shadow:0 14px 30px rgba(0,0,0,.10);
      display:grid;
      place-items:center;
      overflow:hidden;
      padding:14px;
      min-height:380px;
    }
    .mainImg img{width:100%; height:100%; object-fit:contain; border-radius:14px}

    .info{padding:18px 18px 20px;}
    .info .crumbMini{
      display:inline-flex;
      align-items:center;
      padding:7px 11px;
      border-radius:999px;
      border:1px dashed rgba(14,126,160,.35);
      background: rgba(14,126,160,.06);
      color: var(--sea);
      font-weight:900;
      letter-spacing:.25px;
      text-transform:uppercase;
      font-size:12px;
      margin-bottom:10px;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    h1{margin:0 0 8px; font-size:34px; letter-spacing:.2px;}
    .price{
      font-size:22px;
      font-weight:900;
      color: var(--sea); /* NON rosso */
      margin-bottom:14px;
    }
    .divider{height:1px; background:var(--line); margin:14px 0}

    .buyRow{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .qty{
      display:inline-flex; align-items:center;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background:#fff;
    }
    .qty button{
      width:42px; height:42px;
      border:0;
      background:transparent;
      cursor:pointer;
      font-size:18px;
      color:var(--ink);
    }
    .qty input{
      width:56px; height:42px;
      border:0; outline:none;
      text-align:center;
      font-weight:900;
      font-size:15px;
      background:transparent;
    }
    .add{
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, #fff, rgba(242,231,201,.35));
      border-radius:999px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 26px rgba(0,0,0,.08);
    }
    .add:hover{border-color:rgba(14,126,160,.35)}
    .wa{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(14,126,160,.22);
      background: rgba(14,126,160,.06);
      color: var(--ink);
      font-weight:800;
      text-decoration:none;
    }

    .meta{margin-top:14px; padding-top:10px; border-top:1px solid var(--line);}
    .metaRow{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
      margin:8px 0 10px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }
    .metaRow strong{color:var(--ink)}

    /* ✅ card bianca piccola sotto Produttore */
    .miniCard{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px 12px;
      font-weight:900;
      color:var(--ink);
      min-height:44px;
      display:flex;
      align-items:center;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .hint{margin-top:10px; color:var(--muted); font-size:13px; font-weight:700;}
    .err{
      padding:16px;
      border:1px solid rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
      border-radius:16px;
      color:#991b1b;
      font-weight:900;
    }

    @media (max-width: 980px){
      .sheet-body{grid-template-columns:1fr}
      .gallery{border-right:0; border-bottom:1px solid var(--line)}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="images/logo/logo-transparent.png" alt="Il Capitano">
        <div>
          <div>Il Capitano</div>
          <div class="sub">Dal 1938 • Accessori nautici & pesca sportiva e professionale</div>
        </div>
      </div>
      <a class="btn" href="index.html">← Torna ai prodotti</a>
    </div>
  </header>

  <main class="wrap">
    <section class="sheet" id="sheet" aria-live="polite">
      <div class="sheet-head">
        <div class="crumbPill" id="crumbTop">—</div>
        <div class="sku" id="skuTop">SKU: —</div>
      </div>

      <div class="sheet-body">
        <!-- GALLERY -->
        <div class="gallery">
          <div class="thumbs" id="thumbs"></div>
          <div class="mainImg">
            <img id="mainImage" alt="" src="images/placeholder.png" />
          </div>
        </div>

        <!-- INFO -->
        <div class="info">
          <div class="crumbMini" id="crumbMini">—</div>
          <h1 id="title">—</h1>
          <div class="price" id="price">—</div>

          <div class="divider"></div>

          <div class="buyRow">
            <div class="qty" aria-label="Quantità">
              <button type="button" id="qtyMinus">−</button>
              <input id="qtyInput" inputmode="numeric" value="1" />
              <button type="button" id="qtyPlus">+</button>
            </div>

            <button class="add" type="button" id="addBtn">Aggiungi al carrello</button>
          </div>

          <a class="wa" id="waBtn" href="#" rel="noopener">WhatsApp assistenza</a>

          <div class="meta">
            <div class="metaRow">
              <span>Produttore:</span>
              <strong id="producerText"></strong>
            </div>

            <!-- ✅ QUI mettiamo la categoria completa dal tuo JSON -->
            <div class="miniCard" id="categoryCard">—</div>

            <div class="hint">Per dubbi, scrivici su WhatsApp.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // ✅ Path del tuo JSON (modifica se diverso)
    const CATALOG_URL = "catalogo.json";

    // WhatsApp (numero in formato internazionale senza + e senza spazi)
    const WHATSAPP_NUMBER = "393331234567";

    /***********************
     * UTILS
     ***********************/
    const $ = (s) => document.querySelector(s);

    function getParam(name){
      const u = new URL(location.href);
      return (u.searchParams.get(name) || "").trim();
    }

    // accetta più parametri
    function getRequestedCode(){
      return (
        getParam("cod") ||
        getParam("codice") ||
        getParam("sku") ||
        getParam("id") ||
        getParam("code")
      ).trim();
    }

    function normalizeSpaces(s){
      return String(s || "")
        .replace(/\s+/g, " ")
        .replace(/\s*»\s*/g, " » ")
        .trim();
    }

    function formatPrice(v){
      if (v === null || v === undefined) return "";
      let s = String(v).trim();
      if (!s) return "";

      // nel tuo JSON è già "10.00 €" o "-10.00 €"
      s = s.replace(/\s+/g, " ").trim();

      // se è negativo (tipo "-10.00 €") lo trasformo in "10,00 €"
      // (se invece vuoi mostrarlo così com'è, dimmelo e tolgo questa parte)
      const m = s.match(/^-?\s*([\d.,]+)\s*€?$/);
      if (m){
        let num = m[1].replace(/\./g, "").replace(",", ".");
        const n = Number(num);
        if (Number.isFinite(n)){
          const abs = Math.abs(n);
          return abs.toFixed(2).replace(".", ",") + " €";
        }
      }

      // fallback
      if (!s.includes("€")) s += " €";
      return s;
    }

    // il tuo JSON potrebbe essere un array puro oppure dentro una chiave
    function extractProducts(json){
      if (Array.isArray(json)) return json;
      const keys = ["prodotti","products","items","articoli","data"];
      for (const k of keys){
        if (Array.isArray(json?.[k])) return json[k];
      }
      // fallback: primo array trovato in root
      for (const k of Object.keys(json || {})){
        if (Array.isArray(json[k])) return json[k];
      }
      return [];
    }

    // matching sul campo "Cod."
    function matchByCode(p, code){
      if (!code) return false;
      const c = String(p?.["Cod."] ?? "").trim();
      return c === code;
    }

    // immagini: se nel JSON non ci sono, mettiamo 3 placeholder (così la colonna sinistra resta come in foto)
    function getImages(p){
      const imgs = [];
      // se in futuro aggiungi chiavi tipo "Immagine" o "Immagini" le agganciamo qui
      if (p?.Immagine) imgs.push(String(p.Immagine).trim());
      if (Array.isArray(p?.Immagini)) imgs.push(...p.Immagini);

      const cleaned = imgs.map(x => String(x).trim()).filter(Boolean);
      const uniq = [...new Set(cleaned)];

      if (uniq.length) return uniq;

      // 3 placeholder per imitare la UI della foto
      return ["images/placeholder.png","images/placeholder.png","images/placeholder.png"];
    }

    /***********************
     * RENDER
     ***********************/
    function renderProduct(p){
      const title = String(p?.Descrizione || "Prodotto").trim();
      const code  = String(p?.["Cod."] || "").trim();

      const categoryFull = normalizeSpaces(p?.Categoria || "");
      const producer = String(p?.Produttore || "").trim(); // se vuoto resta vuoto
      const price = formatPrice(p?.["Listino 1 (ivato)"]);

      $("#title").textContent = title;
      $("#price").textContent = price || "—";
      $("#skuTop").textContent = code ? `SKU: ${code}` : "SKU: —";

      const crumb = categoryFull || "—";
      $("#crumbTop").textContent = crumb;
      $("#crumbMini").textContent = crumb;

      // Produttore: se manca deve essere vuoto (come richiesto)
      $("#producerText").textContent = producer ? producer : "";

      // ✅ Card sotto produttore riempita con tutta la categoria
      $("#categoryCard").textContent = crumb;

      // WhatsApp
      const msg = encodeURIComponent(`Ciao! Ho una domanda sul prodotto "${title}" (SKU: ${code || "—"}).`);
      $("#waBtn").href = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;

      // immagini
      const imgs = getImages(p);
      const thumbs = $("#thumbs");
      thumbs.innerHTML = "";

      function setMain(src){
        $("#mainImage").src = src;
        $("#mainImage").alt = title;
      }

      imgs.forEach((src, i) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "thumb" + (i===0 ? " active" : "");
        btn.innerHTML = `<img src="${src}" alt="">`;
        btn.addEventListener("click", () => {
          setMain(src);
          [...thumbs.children].forEach(x => x.classList.remove("active"));
          btn.classList.add("active");
        });
        thumbs.appendChild(btn);
      });

      setMain(imgs[0]);
      document.title = `${title} • Il Capitano`;
    }

    function renderError(message){
      $("#sheet").innerHTML = `<div class="err">${message}</div>`;
    }

    /***********************
     * QTY + ADD
     ***********************/
    function clampQty(v){
      const n = Number(String(v).replace(/[^\d]/g,""));
      if (!Number.isFinite(n) || n < 1) return 1;
      if (n > 99) return 99;
      return n;
    }

    $("#qtyMinus").addEventListener("click", ()=>{
      $("#qtyInput").value = clampQty(Number($("#qtyInput").value) - 1);
    });
    $("#qtyPlus").addEventListener("click", ()=>{
      $("#qtyInput").value = clampQty(Number($("#qtyInput").value) + 1);
    });
    $("#qtyInput").addEventListener("input", ()=>{
      $("#qtyInput").value = clampQty($("#qtyInput").value);
    });

    $("#addBtn").addEventListener("click", ()=>{
      const qty = clampQty($("#qtyInput").value);
      alert(`Aggiunto al carrello: ${qty} pz`);
    });

    /***********************
     * BOOT
     ***********************/
    (async function init(){
      const code = getRequestedCode();
      if (!code){
        renderError("Codice prodotto mancante nell’URL. Esempio: prodotto.html?cod=0016189");
        return;
      }

      try{
        const res = await fetch(CATALOG_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const json = await res.json();
        const products = extractProducts(json);

        const p = products.find(x => matchByCode(x, code));
        if (!p){
          renderError(`Prodotto non trovato (Cod.: ${code}).`);
          return;
        }

        renderProduct(p);
      }catch(err){
        renderError("Errore nel caricamento del catalogo. Controlla CATALOG_URL e il JSON. (" + err.message + ")");
      }
    })();
  </script>
</body>
</html>
